
@{
    ViewBag.Title = "Detalle del Producto";
    Layout = "~/Views/Shared/_Layout.cshtml";
}




<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" href="@Url.Action("Index","Tienda")">Volver</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>

        </div>
    </nav>

    <section class="py-5">
        <div class="container px-4 px-lg-5 my-5">
            <div id="product-detail-container" class="row gx-4 gx-lg-5 align-items-center">
                <div class="col-12 text-center py-5">
                    <i class="fas fa-spinner fa-spin fa-3x"></i>
                    <p class="mt-3">Cargando detalles del producto...</p>
                </div>
            </div>
        </div>
    </section>


    <section class="py-5 bg-light">
        <div class="container px-4 px-lg-5 mt-5">

            <h2 class="fw-bolder mb-4 text-center">Mas Productos</h2>

            <div class="container-fluid px-5 my-5">
                <div class="row">
                    <div class="col-sm-12 mx-auto">
                        <div id="contenedor_productos" class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>



</body>

@section scripts {
    <script>


        function getQueryParameter(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
            var results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        function cargarDetalleProducto(idProducto) {
            if (idProducto === 0) {
                $('#product-detail-container').html('<div class="col-12 text-center py-5"><p class="text-danger">ID de producto no proporcionado.</p></div>');
                return;
            }

            $.ajax({
                url: "@Url.Action("ObtenerProductoPorId", "Tienda")",
                type: "GET",
                data: { idProducto: idProducto },
                dataType: "json",
                success: function (data) {
                    if (data.data) {
                        let producto = data.data;
                        let htmlDetalle = `
                            <div class="col-md-6">
                                <img class="card-img-top mb-5 mb-md-0" src="https://dummyimage.com/600x700/dee2e6/6c757d.jpg" alt="Cargando Imagen..." id="detail-img-producto-${producto.id_producto}" />
                            </div>
                            <div class="col-md-6">
                                <div class="small mb-1">SKU: ${producto.id_producto}</div> <h1 class="display-5 fw-bolder">${producto.nombre}</h1>
                                <div class="fs-5 mb-5">
                                    <span>Bs. ${producto.precio.toFixed(2).replace('.', ',')}</span>
                                    ${!producto.estado ? '<span class="badge bg-danger text-white ms-3">No Disponible</span>' : ''}
                                </div>
                                <p class="lead">${producto.descripcion}</p>
                                <p class="small text-muted mb-0">Marca: ${producto.marca ? producto.marca.descripcion : 'N/A'}</p>
                                <p class="small text-muted">Categoría: ${producto.categoria ? producto.categoria.descripcion : 'N/A'}</p>
                                <div class="d-flex">
                                    <input class="form-control text-center me-3" id="inputQuantity" type="num" value="1" style="max-width: 3rem" />
                                    <button class="btn btn-outline-dark flex-shrink-0" type="button" ${!producto.estado ? 'disabled' : ''}>
                                        <i class="bi-cart-fill me-1"></i>
                                        Agregar al Carrito
                                    </button>
                                </div>
                            </div>
                        `;
                        $('#product-detail-container').html(htmlDetalle);

                        // Load the image for the main product detail
                        if (producto.nombre_imagen && producto.ruta_imagen) {
                            $(`#detail-img-producto-${producto.id_producto}`).LoadingOverlay("show", {
                                imageResizeFactor: 2,
                                text: "Cargando imagen...",
                                size: 24,
                                textClass: "text-muted"
                            });

                            $.ajax({
                                url: "@Url.Action("ImagenProductoCatalogo", "Tienda")",
                                type: "POST",
                                data: JSON.stringify({ id: producto.id_producto }),
                                dataType: "json",
                                contentType: "application/json; charset=utf-8",
                                success: function (imageData) {
                                    $(`#detail-img-producto-${producto.id_producto}`).LoadingOverlay("hide");
                                    if (imageData.conversion && imageData.textoBase64) {
                                        $(`#detail-img-producto-${producto.id_producto}`).attr("src", `data:image/${imageData.Extension.replace('.', '')};base64,${imageData.textoBase64}`);
                                    } else {
                                        $(`#detail-img-producto-${producto.id_producto}`).attr("src", "https://dummyimage.com/600x700/ccc/fff&text=Imagen+no+disponible");
                                        console.warn(`No se pudo cargar la imagen para el producto ${producto.id_producto}: ${imageData.mensaje}`);
                                    }
                                },
                                error: function (error) {
                                    $(`#detail-img-producto-${producto.id_producto}`).LoadingOverlay("hide");
                                    $(`#detail-img-producto-${producto.id_producto}`).attr("src", "https://dummyimage.com/600x700/ccc/fff&text=Error+al+cargar+imagen");
                                    console.error(`Error al obtener la imagen para el producto ${producto.id_producto}:`, error);
                                }
                            });
                        } else {
                             $(`#detail-img-producto-${producto.id_producto}`).attr("src", "https://dummyimage.com/600x700/ccc/fff&text=Sin+imagen");
                        }

                    } else {
                        $('#product-detail-container').html('<div class="col-12 text-center py-5"><p class="text-danger">Producto no encontrado.</p></div>');
                    }
                },
                error: function (error) {
                    console.error("Error al cargar detalle del producto:", error);
                    $('#product-detail-container').html('<div class="col-12 text-center py-5"><p class="text-danger">Error al cargar los detalles del producto.</p></div>');
                }
            });
        }
        // Función para cargar categorías
        function cargarCategorias() {
            $.ajax({
                url: "@Url.Action("ListaCategoria", "Tienda")",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    let html = '';
                    $.each(data.data, function (index, categoria) {
                            html += `<div class="form-check">
                                <input class="form-check-input filtro-categoria" type="checkbox" value="${categoria.id_categoria}" id="categoria-${categoria.id_categoria}">
                                <label class="form-check-label" for="categoria-${categoria.id_categoria}">
                                    ${categoria.descripcion}
                                </label>
                            </div>`;
                        // }
                    });
                    $('#contenedor_categoria').html(html);
                },
                error: function (error) {
                    console.error("Error al cargar categorías:", error);
                }
            });
        }

        // Función para cargar marcas
        function cargarMarcas() {
            $.ajax({
                url: "@Url.Action("ListarMarcas", "Tienda")",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    let html = '';
                    $.each(data.data, function (index, marca) {
                            html += `<div class="form-check">
                                <input class="form-check-input filtro-marca" type="checkbox" value="${marca.id_marca}" id="marca-${marca.id_marca}">
                                <label class="form-check-label" for="marca-${marca.id_marca}">
                                    ${marca.descripcion}
                                </label>
                            </div>`;

                    });
                    $('#contenedor_marca').html(html);
                },
                error: function (error) {
                    console.error("Error al cargar marcas:", error);
                }
            });
        }

        function cargarProductos(idMarca = 0, idCategoria = 0) {
            $('#contenedor_productos').html('<div class="text-center w-100 py-5"><i class="fas fa-spinner fa-spin fa-3x"></i><p class="mt-3">Cargando productos...</p></div>');

            $.ajax({
                url: "@Url.Action("ListarProductosCatalogo", "Tienda")",
                type: "GET",
                data: { idMarca: idMarca, idCategoria: idCategoria },
                dataType: "json",
                success: function (data) {
                    let htmlProductos = '';
                    if (data.data.length === 0) {
                        htmlProductos = '<div class="text-center w-100 py-5"><p>No se encontraron productos con los filtros seleccionados.</p></div>';
                    } else {
                        $.each(data.data, function (index, producto) {
                            htmlProductos += `
                                <div class="col mb-5">
                                    <div class="card h-100">
                                        ${!producto.estado ? '<div class="badge bg-danger text-white position-absolute" style="top: 0.5rem; right: 0.5rem">No Disponible</div>' : ''}

                                        <img class="card-img-top img-fluid" style="height: 200px; object-fit: contain;" src="https://dummyimage.com/450x300/dee2e6/6c757d.jpg" alt="Cargando Imagen..." id="img-producto-${producto.id_producto}" />

                                        <div class="card-body p-4">
                                            <div class="text-center">
                                                <h5 class="fw-bolder">${producto.nombre}</h5>
                                                <p>${producto.descripcion}</p>
                                                <p><strong>Precio:</strong> Bs. ${producto.precio.toFixed(2).replace('.', ',')}</p>
                                                <p class="small text-muted mb-0">Marca: ${producto.marca ? producto.marca.descripcion : 'N/A'}</p>
                                                <p class="small text-muted">Categoría: ${producto.categoria ? producto.categoria.descripcion : 'N/A'}</p>
                                            </div>
                                        </div>
                                        <div class="card-footer p-4 pt-0 border-top-0 bg-transparent">
                                            <div class="text-center">
                                                <a class="btn btn-outline-dark mt-auto" href="/Tienda/DetalleProducto?idProducto=${producto.id_producto}">Ver Detalles</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    $('#contenedor_productos').html(htmlProductos);

                    $.each(data.data, function (index, producto) {
                        if (producto.nombre_imagen && producto.ruta_imagen) {
                            $(`#img-producto-${producto.id_producto}`).LoadingOverlay("show", {
                                imageResizeFactor: 2,
                                text: "Cargando imagen...",
                                size: 24,
                                textClass: "text-muted"
                            });

                            $.ajax({
                                url: "@Url.Action("ImagenProductoCatalogo", "Tienda")",
                                type: "POST",
                                data: JSON.stringify({ id: producto.id_producto }),
                                dataType: "json",
                                contentType: "application/json; charset=utf-8",
                                success: function (imageData) {
                                    $(`#img-producto-${producto.id_producto}`).LoadingOverlay("hide");
                                    if (imageData.conversion && imageData.textoBase64) {
                                        $(`#img-producto-${producto.id_producto}`).attr("src", `data:image/${imageData.Extension.replace('.', '')};base64,${imageData.textoBase64}`);
                                    } else {
                                        $(`#img-producto-${producto.id_producto}`).attr("src", "https://dummyimage.com/450x300/ccc/fff&text=Imagen+no+disponible");
                                        console.warn(`No se pudo cargar la imagen para el producto ${producto.id_producto}: ${imageData.mensaje}`);
                                    }
                                },
                                error: function (error) {
                                    $(`#img-producto-${producto.id_producto}`).LoadingOverlay("hide");
                                    $(`#img-producto-${producto.id_producto}`).attr("src", "https://dummyimage.com/450x300/ccc/fff&text=Error+al+cargar+imagen");
                                    console.error(`Error al obtener la imagen para el producto ${producto.id_producto}:`, error);
                                }
                            });
                        } else {
                            $(`#img-producto-${producto.id_producto}`).attr("src", "https://dummyimage.com/450x300/ccc/fff&text=Sin+imagen");
                        }
                    });
                },
                error: function (error) {
                    console.error("Error al cargar productos:", error);
                    $('#contenedor_productos').html('<div class="text-center w-100 py-5"><p class="text-danger">Error al cargar los productos.</p></div>');
                }
            });
        }

        $(document).ready(function () {
            cargarCategorias();
            cargarMarcas();
            cargarProductos();

            $('#btnAplicarFiltro').click(function () {
                let idCategoriaSeleccionada = 0;
                let idMarcaSeleccionada = 0;

                let selectedCategory = $('.filtro-categoria:checked').val();
                if (selectedCategory) {
                    idCategoriaSeleccionada = parseInt(selectedCategory);
                }

                let selectedBrand = $('.filtro-marca:checked').val();
                if (selectedBrand) {
                    idMarcaSeleccionada = parseInt(selectedBrand);
                }

                console.log("Filtro Categoria:", idCategoriaSeleccionada);
                console.log("Filtro Marca:", idMarcaSeleccionada);

                cargarProductos(idMarcaSeleccionada, idCategoriaSeleccionada);
            });
        });
    </script>
}
