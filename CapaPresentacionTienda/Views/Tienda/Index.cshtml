@{
    ViewBag.Title = "Catalogo de la Tienda";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<header class="bg-dark" style="background-image: url('@Url.Content("~/Content/imagenes/fondositioweb1.png")'); background-size: cover; background-position: center; padding-top: 10rem; padding-bottom: 10rem;">
    <div class="container px-4 px-lg-5 my-5">
        <div class="text-center text-white">
            <h1 class="display-4 fw-bolder" style="color: #ffffff;">Compra con garantia</h1>
            <p class="lead fw-normal mb-0" style="color: #ffffff;">Encuentras los mejores productos para tu movilidad</p>
        </div>
    </div>
</header>


<section>
    <div class="container-fluid px-5 my-5">
        <div class="row">

            <div class="col-sm-3">

                <div class="row mb-3">
                    <div class="row mb-12">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                Categorias
                            </div>
                            <div id="contenedor_categoria" class="card-body">
                            </div>

                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="row mb-12">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                Marcas
                            </div>
                            <div id="contenedor_marca" class="card-body">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="row mb-12">
                        <div class="d-grid gap-2">
                            
                            <button id="btnAplicarFiltro" class="btn btn-block" type="button" style="background-color: #e7333a; color: white; border-color: #e7333a;">
                                <i class="fas fa-filter"></i>Aplicar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-9">
                <div id="contenedor_productos" class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
                </div>
            </div>

        </div>

    </div>
</section>

@section scripts {
    <script>
        // Función para cargar categorías
        function cargarCategorias() {
            $.ajax({
                url: "@Url.Action("ListaCategoria", "Tienda")",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    let html = '';
                    $.each(data.data, function (index, categoria) {
                            html += `<div class="form-check">
                                <input class="form-check-input filtro-categoria" type="checkbox" value="${categoria.id_categoria}" id="categoria-${categoria.id_categoria}">
                                <label class="form-check-label" for="categoria-${categoria.id_categoria}">
                                    ${categoria.descripcion}
                                </label>
                            </div>`;
                        // }
                    });
                    $('#contenedor_categoria').html(html);
                },
                error: function (error) {
                    console.error("Error al cargar categorías:", error);
                }
            });
        }

        // Función para cargar marcas
        function cargarMarcas() {
            $.ajax({
                url: "@Url.Action("ListarMarcas", "Tienda")",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    let html = '';
                    $.each(data.data, function (index, marca) {
                            html += `<div class="form-check">
                                <input class="form-check-input filtro-marca" type="checkbox" value="${marca.id_marca}" id="marca-${marca.id_marca}">
                                <label class="form-check-label" for="marca-${marca.id_marca}">
                                    ${marca.descripcion}
                                </label>
                            </div>`;

                    });
                    $('#contenedor_marca').html(html);
                },
                error: function (error) {
                    console.error("Error al cargar marcas:", error);
                }
            });
        }

        function cargarProductos(idMarca = 0, idCategoria = 0) {
            $('#contenedor_productos').html('<div class="text-center w-100 py-5"><i class="fas fa-spinner fa-spin fa-3x"></i><p class="mt-3">Cargando productos...</p></div>');

            $.ajax({
                url: "@Url.Action("ListarProductosCatalogo", "Tienda")",
                type: "GET",
                data: { idMarca: idMarca, idCategoria: idCategoria },
                dataType: "json",
                success: function (data) {
                    let htmlProductos = '';
                    if (data.data.length === 0) {
                        htmlProductos = '<div class="text-center w-100 py-5"><p>No se encontraron productos con los filtros seleccionados.</p></div>';
                    } else {
                        $.each(data.data, function (index, producto) {
                            htmlProductos += `
                                <div class="col mb-5">
                                    <div class="card h-100">
                                        ${!producto.estado ? '<div class="badge bg-danger text-white position-absolute" style="top: 0.5rem; right: 0.5rem">No Disponible</div>' : ''}

                                        <img class="card-img-top img-fluid" style="height: 200px; object-fit: contain;" src="https://dummyimage.com/450x300/dee2e6/6c757d.jpg" alt="Cargando Imagen..." id="img-producto-${producto.id_producto}" />

                                        <div class="card-body p-4">
                                            <div class="text-center">
                                                <h5 class="fw-bolder">${producto.nombre}</h5>
                                                <p>${producto.descripcion}</p>
                                                <p><strong>Precio:</strong> Bs. ${producto.precio.toFixed(2).replace('.', ',')}</p>
                                                <p class="small text-muted mb-0">Marca: ${producto.marca ? producto.marca.descripcion : 'N/A'}</p>
                                                <p class="small text-muted">Categoría: ${producto.categoria ? producto.categoria.descripcion : 'N/A'}</p>
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                            `;
                        });
                    }
                    //<div class="card-footer p-4 pt-0 border-top-0 bg-transparent">
                    //    <div class="text-center">
                    //        <a class="btn btn-outline-dark mt-auto" href="/Tienda/DetalleProducto?idProducto=${producto.id_producto}">Ver Detalles</a>
                    //    </div>
                    //</div>

                    $('#contenedor_productos').html(htmlProductos);

                    $.each(data.data, function (index, producto) {
                        if (producto.nombre_imagen && producto.ruta_imagen) {
                            $(`#img-producto-${producto.id_producto}`).LoadingOverlay("show", {
                                imageResizeFactor: 2,
                                text: "Cargando imagen...",
                                size: 24,
                                textClass: "text-muted"
                            });

                            $.ajax({
                                url: "@Url.Action("ImagenProductoCatalogo", "Tienda")",
                                type: "POST",
                                data: JSON.stringify({ id: producto.id_producto }),
                                dataType: "json",
                                contentType: "application/json; charset=utf-8",
                                success: function (imageData) {
                                    $(`#img-producto-${producto.id_producto}`).LoadingOverlay("hide");
                                    if (imageData.conversion && imageData.textoBase64) {
                                        $(`#img-producto-${producto.id_producto}`).attr("src", `data:image/${imageData.Extension.replace('.', '')};base64,${imageData.textoBase64}`);
                                    } else {
                                        $(`#img-producto-${producto.id_producto}`).attr("src", "https://dummyimage.com/450x300/ccc/fff&text=Imagen+no+disponible");
                                        console.warn(`No se pudo cargar la imagen para el producto ${producto.id_producto}: ${imageData.mensaje}`);
                                    }
                                },
                                error: function (error) {
                                    $(`#img-producto-${producto.id_producto}`).LoadingOverlay("hide");
                                    $(`#img-producto-${producto.id_producto}`).attr("src", "https://dummyimage.com/450x300/ccc/fff&text=Error+al+cargar+imagen");
                                    console.error(`Error al obtener la imagen para el producto ${producto.id_producto}:`, error);
                                }
                            });
                        } else {
                            $(`#img-producto-${producto.id_producto}`).attr("src", "https://dummyimage.com/450x300/ccc/fff&text=Sin+imagen");
                        }
                    });
                },
                error: function (error) {
                    console.error("Error al cargar productos:", error);
                    $('#contenedor_productos').html('<div class="text-center w-100 py-5"><p class="text-danger">Error al cargar los productos.</p></div>');
                }
            });
        }

        $(document).ready(function () {
            cargarCategorias();
            cargarMarcas();
            cargarProductos();

            $('#btnAplicarFiltro').click(function () {
                let idCategoriaSeleccionada = 0;
                let idMarcaSeleccionada = 0;

                let selectedCategory = $('.filtro-categoria:checked').val();
                if (selectedCategory) {
                    idCategoriaSeleccionada = parseInt(selectedCategory);
                }

                let selectedBrand = $('.filtro-marca:checked').val();
                if (selectedBrand) {
                    idMarcaSeleccionada = parseInt(selectedBrand);
                }

                console.log("Filtro Categoria:", idCategoriaSeleccionada);
                console.log("Filtro Marca:", idMarcaSeleccionada);

                cargarProductos(idMarcaSeleccionada, idCategoriaSeleccionada);
            });
        });
    </script>
}