@{
    ViewBag.Title = "Reporte de Ventas";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

<h1 class="mt-4">Reporte de Ventas</h1>
<ol class="breadcrumb mb-4">
    <li class="breadcrumb-item active">Reporte de Ventas</li>
</ol>

@*<div class="row mt-4 animate__animated animate__fadeIn">
    <div class="col-xl-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header text-primary">
                <i class="fa-solid fa-chart-line me-2"></i> Tendencia de Ventas (Semanal)
            </div>
            <div class="card-body">
                <canvas id="salesTrendChart" width="100%" height="40"></canvas>
            </div>
        </div>
    </div>

    <div class="col-xl-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header text-primary">
                <i class="fa-solid fa-box-open me-2"></i> Top 5 Productos/Servicios Más Vendidos
            </div>
            <div class="card-body">
                <canvas id="topItemsChart" width="100%" height="40"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row animate__animated animate__fadeIn">
    <div class="col-xl-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header text-primary">
                <i class="fa-solid fa-user-group me-2"></i> Top 5 Clientes por Volumen de Compra
            </div>
            <div class="card-body">
                <canvas id="topClientsChart" width="100%" height="40"></canvas>
            </div>
        </div>
    </div>
</div>*@

<div class="card shadow-sm animate__animated animate__fadeIn mb-4">
    <div class="card-header text-primary">
        <i class="fa-solid fa-clock-rotate-left me-2"></i> Historial de Ventas
    </div>
    <div class="card-body">
        <form>
            <div class="row align-items-end">
                <div class="col-sm-2 mb-2">
                    <label class="form-label">Fecha de Inicio:</label>
                    <input class="form-control" type="date" id="txtfechainicio" name="fechainicio" />
                </div>

                <div class="col-sm-2 mb-2">
                    <label class="form-label">Fecha Fin:</label>
                    <input class="form-control" type="date" id="txtfechafin" name="fechafin" />
                </div>

                <div class="col-sm-2 mb-2">
                    <label class="form-label">Nº de Factura:</label>
                    <input class="form-control" type="text" id="txtidtransaccion" name="idtransaccion" />
                </div>

                <div class="col-sm-2 mb-2">
                    <button class="btn btn-outline-primary w-100" id="btnbuscar" type="button">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>

                <div class="col-sm-2 mb-2">
                    <button class="btn btn-outline-success w-100" id="btnExportarExcel" type="button">
                        <i class="fas fa-file-excel"></i> Exportar
                    </button>
                </div>
            </div>
        </form>

        <hr />
        <div class="table-responsive">
            <table id="tabla" class="display cell-border" style="width:100%">
                <thead>
                    <tr>
                        <th>Fecha Venta</th>
                        <th>Cliente</th>
                        <th>Producto/Servicio</th>
                        <th>Tipo Ítem</th>
                        <th>Precio Unitario</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th>Nº de Factura</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalleVenta" tabindex="-1" aria-labelledby="modalDetalleVentaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalDetalleVentaLabel">Detalle de Venta <span id="modalIdVenta"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modalContentLoader" class="text-center my-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando detalle de venta...</p>
                </div>
                <div id="invoiceDetailContainer">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>

    <script>
        $(function () {
            const tablaHistorialVentas = $('#tabla').DataTable({
                responsive: true,
                ajax: {
                    url: '@Url.Action("ObtenerHistorialVentas", "Home")',
                    type: "GET",
                    dataType: "json",
                    data: function (d) {
                        d.fechaInicio = $("#txtfechainicio").val();
                        d.fechaFin = $("#txtfechafin").val();
                        d.idVenta = $("#txtidtransaccion").val();
                    },
                    dataSrc: "data"
                },
                columns: [
                    {
                        data: "fechaVenta",
                        render: function (data) {
                            return data ? moment(data).format('DD/MM/YYYY') : '';
                        }
                    },
                    { data: "nombreCliente" },
                    { data: "nombreItem" },
                    { data: "tipoItem" },
                    {
                        data: "precioUnitario",
                        render: d => 'Bs./ ' + parseFloat(d).toFixed(2)
                    },
                    { data: "cantidad" },
                    {
                        data: "subTotal",
                        render: d => 'Bs./ ' + parseFloat(d).toFixed(2)
                    },
                    { data: "idVenta" },
                    {
                        data: "idVenta",
                        render: function (data, type, row) {
                            return `<button class="btn btn-info btn-sm btn-detalle-venta" data-idventa="${data}" data-bs-toggle="modal" data-bs-target="#modalDetalleVenta"><i class="fas fa-eye"></i></button>`;
                        },
                        orderable: false,
                        searchable: false
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/2.2.1/i18n/es-ES.json'
                },
                ordering: false,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
                pageLength: -1
            });

            $("#btnbuscar").on("click", () => tablaHistorialVentas.ajax.reload());

            $("#btnExportarExcel").on("click", function () {
                const fechaInicio = $("#txtfechainicio").val();
                const fechaFin = $("#txtfechafin").val();
                const idVenta = $("#txtidtransaccion").val();

                // Validar que se haya ingresado una fecha de inicio y fin
                if (!fechaInicio || !fechaFin) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor, ingrese una fecha de inicio y una fecha de fin.'
                    });
                    return; 
                }

                // Validar que la fecha de inicio sea anterior a la fecha de fin
                //moment.js para una comparación de fechas más robusta
                if (moment(fechaInicio).isAfter(moment(fechaFin))) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'La fecha de inicio debe ser anterior a la fecha de fin.'
                    });
                    return; 
                }


                const url = '@Url.Action("ExportarHistorialVentasExcel", "Operaciones")' +
                            '?fechaInicio= ' + encodeURIComponent(fechaInicio) +
                            '&fechaFin=' + encodeURIComponent(fechaFin) +
                    '&idTransaccion=' + encodeURIComponent(idVenta);

                window.location.href = url;

            });

            $('#tabla tbody').on('click', '.btn-detalle-venta', function () {
                const idVenta = $(this).data('idventa');
                console.log('ID de Venta:', idVenta);

                $('#modalContentLoader').show();
                $('#invoiceDetailContainer').empty();
                $('#modalIdVenta').text(idVenta);

                $.ajax({
                    url: '@Url.Action("ObtenerDetalleVenta", "Operaciones")',
                    type: 'GET',
                    data: { idVenta: idVenta },
                    success: function (response) {
                        $('#modalContentLoader').hide();
                        $('#invoiceDetailContainer').html(response);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error al cargar el detalle de venta:", error);
                        $('#modalContentLoader').hide();
                        $('#invoiceDetailContainer').html('<p class="text-danger">Error al cargar el detalle de la venta. Inténtelo de nuevo.</p>');
                    }
                });
            });
        });
    </script>
}